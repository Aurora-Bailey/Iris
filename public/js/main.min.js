"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}String.prototype.toUpperCaseFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),__DEV=!0,__DOMAIN="kyros.pw",Lib=function(){function Lib(){_classCallCheck(this,Lib)}return _createClass(Lib,null,[{key:"validateEmail",value:function(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email)}},{key:"validateUsername",value:function(username){var re=/^[a-zA-Z0-9\/-]+$/;return re.test(username)}},{key:"randString",value:function(len,upper,lower,num){var text="",possible="";if(upper&&(possible+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),lower&&(possible+="abcdefghijklmnopqrstuvwxyz"),num&&(possible+="0123456789"),""==possible)return!1;for(var i=0;len>i;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}},{key:"toggleArrayItem",value:function(array,item){var index=array.indexOf(item);index>-1?delete array[index]:array.push(item);var newArray=[];return array.forEach(function(value){newArray.push(value)}),newArray}},{key:"backdrop",value:function($jObj,clickback){var $backdrop=$("<div></div>");return $backdrop.addClass("backdrop"),$backdrop.css({"z-index":parseInt($jObj.css("z-index"))-1,display:"none"}),$backdrop.click(clickback),$("body").append($backdrop),$backdrop.open=function(){$backdrop.fadeIn(100)},$backdrop.close=function(){$backdrop.fadeOut(100)},$backdrop}},{key:"getDropText",value:function(dropEvent){var isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1,isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,temp_url=(navigator.userAgent.toLowerCase().indexOf("msie")>-1,""),temp_text="",html_text="",event=dropEvent;if("undefined"!=typeof event.originalEvent&&(event=dropEvent.originalEvent),temp_text=event.dataTransfer.getData("Text"),temp_url=event.dataTransfer.getData("Url"),isFirefox){var temp=event.dataTransfer.getData("text/x-moz-url");temp=temp.match(/[^\r\n]+/g),null!==temp&&"undefined"!=typeof temp&&"undefined"!=typeof temp[0]&&(temp_url=temp[0]),null!==temp&&"undefined"!=typeof temp&&"undefined"!=typeof temp[1]&&(html_text=temp[1])}if(isChrome){var temp=event.dataTransfer.getData("text/html"),temp_div=document.createElement("div");temp_div.innerHTML=temp,html_text=$(temp_div).text()}return null==temp_url&&(temp_url=""),null==temp_text&&(temp_text=""),null==html_text&&(html_text=""),{url:temp_url,text:temp_text,html:html_text}}},{key:"mergeObjects",value:function(arr){for(var obj={},i=0;i<arr.length;i++)for(var attrname in arr[i])obj[attrname]=arr[i][attrname];return obj}},{key:"getLinkMetadata",value:function(link,callback){if(""==link)return callback({link_title:"",link_image:"",link_description:"",yql:!0}),!1;var extension=link.split(".").pop();if("jpg"==extension||"jpeg"==extension||"png"==extension)return callback({link_title:"",link_description:"",link_image:link,yql:!0}),!1;var yql="http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from html where url="'+link+'" and xpath=\'//meta[contains(@name,"image")]|//meta[contains(@name,"title")]|//meta[contains(@name,"description")]|//meta[contains(@property,"image")]|//meta[contains(@property,"title")]|//meta[contains(@property,"description")]|//title\'')+"&format=json&callback=";$.getJSON(yql,function(data){return callback(Lib.mergeObjects([Lib.metadataObject(data),Lib.linkType(link)])),!0}).fail(function(){return callback({link_title:"",link_image:"",link_description:"",yql:!0}),!1})}},{key:"metadataObject",value:function(data){var _this=this,return_object={link_title:"",link_image:"",link_description:"",yql:!0},results=data.query.results;if(null==results)return return_object;if("undefined"!=typeof results.meta){var meta=results.meta;$.isArray(meta)||(meta=[meta]),meta.forEach(function(value){var name="";"undefined"!=typeof value.name?name=value.name:"undefined"!=typeof value.property&&(name=value.property),"undefined"!=typeof value.content&&("og:image"!=name&&"twitter:image"!=name&&"image"!=name||""!=return_object.link_image&&"gif"!=_this.extractExtension(return_object.link_image)||(return_object.link_image=value.content),"og:description"!=name&&"twitter:description"!=name&&"description"!=name||""==return_object.link_description&&(return_object.link_description=value.content.substr(0,200)),"og:title"!=name&&"twitter:title"!=name&&"title"!=name||""==return_object.link_title&&(return_object.link_title=value.content.substr(0,100)))})}return""==return_object.link_title&&"undefined"!=typeof results.title&&"string"==typeof results.title&&(return_object.link_title=results.title),return_object.link_description=$("<div>"+return_object.link_description+"</div>").html(),return_object.link_title=$("<div>"+return_object.link_title+"</div>").html(),return_object}},{key:"linkType",value:function(link){if(""==link)return{type:"text",content:""};if(this.isImage(link))return{type:"image",content:link};var youtube=this.extractYoutubeID(link);if(""!=youtube)return{type:"youtube",content:youtube};var gifv=this.imgurMP4(link);return""!=gifv?{type:"gifv",content:gifv}:{type:"link",content:link}}},{key:"extractDomain",value:function(url){if(""==url)return"";var domain="";return domain=url.indexOf("://")>-1?url.split("/")[2]:url.split("/")[0],domain=domain.split(":")[0]}},{key:"extractExtension",value:function(url){return""==url?"":-1==url.indexOf(".")?"":url.split(".").pop().split("?")[0]}},{key:"extractYoutubeID",value:function(url){var domain=this.extractDomain(url);return"www.youtube.com"!=domain&&"youtu.be"!=domain&&"youtube.com"!=domain?"":-1==url.indexOf("v=")?"":url.split("v=")[1].split("&")[0]}},{key:"imgurMP4",value:function(url){var domain=this.extractDomain(url);if("www.imgur.com"!=domain&&"imgur.com"!=domain&&"i.imgur.com"!=domain)return"";if("gifv"!=Lib.extractExtension(url))return"";var url_arr=url.split(".");return url_arr.pop(),url_arr.push("mp4"),url_arr.join(".")}},{key:"isImage",value:function(url){var x=this.extractExtension(url);return"jpg"==x||"jpeg"==x||"png"==x||"gif"==x}},{key:"handlePostClick",value:function(element){var $element=$(element),$p=$element.parent(),content=$p.attr("content"),type=$p.attr("type");if("gifv"==type){var gifv=document.createElement("video");gifv.src=content,gifv.load(),gifv.loop=!0,gifv.muted=!0,$(gifv).addClass("video-gifv"),$(gifv).css({width:$element.width(),height:$element.height()}),$(gifv).click(function(){0==this.paused?this.pause():this.play()}),$p.prepend(gifv),$element.addClass("hide"),gifv.play()}else if("youtube"==type){var $ytIframe=$('<iframe type="text/html" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"/>');$ytIframe.attr("src","http://www.youtube.com/embed/"+content+"?autoplay=1"),$ytIframe.addClass("ytIframe"),$p.prepend($ytIframe),$element.addClass("hide")}else if("image"==type){var $viewImage=$('<div class="fullscreen-image"></div>');$viewImage.html('<img src="'+content+'"/>'),$viewImage.click(function(){this.remove()}),$("body").append($viewImage)}return"link"==type}},{key:"screenArea",value:function(){return $(window).width()*$(window).height()}}]),Lib}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Route=function(){function Route(){_classCallCheck(this,Route)}return _createClass(Route,null,[{key:"handle",value:function(msg){var _this=this;return"undefined"==typeof angularScope||angularScope.connected!==!0?(setTimeout(function(){return _this.handle(msg)},200),!1):"undefined"==typeof Facebook||Facebook.connected!==!0?(setTimeout(function(){return _this.handle(msg)},200),!1):("undefined"!=typeof msg.request&&WS.sendObj({x:"page",z:msg.request}),"login"==msg.x?this.login(msg):"echo"==msg.x?this.echo(msg):"post"==msg.x?this.post(msg):"page"==msg.x&&this.page(msg),void angularScope.$apply())}},{key:"login",value:function(msg){"success"==msg.z?angularScope.user=msg.user:"request"==msg.z?Facebook.requestTokenStatus():"update"==msg.z&&(angularScope.userUpdateMsg=msg.text)}},{key:"echo",value:function(msg){angularScope.echo=msg.text}},{key:"post",value:function(msg){"received"==msg.z}},{key:"page",value:function(msg){if(angularScope.page=msg.z,"home"==msg.z){for(var i=0;i<msg.data.length;i++)msg.data[i]=Lib.mergeObjects([msg.data[i],Lib.linkType(msg.data[i].link)]);"undefined"!=typeof msg.concatenate&&msg.concatenate===!0?(angularScope.people=Lib.mergeObjects([angularScope.people,msg.people]),angularScope.posts=angularScope.posts.concat(msg.data),0==msg.data.length&&$("#page-home .load-more").html("EMPTY PAGE").removeClass("empty").addClass("empty")):(angularScope.people=msg.people,angularScope.posts=msg.data,postColumns.reset(),$("#page-home .load-more").html("LOAD MORE").removeClass("empty")),angularScope.$apply(),postColumns.update()}else"guest"==msg.z&&(angularScope.user={name:"Guest"},angularScope.people={},angularScope.posts={})}}]),Route}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),WS=function(){function WS(){_classCallCheck(this,WS)}return _createClass(WS,null,[{key:"init",value:function(){this.server=null,this.connected=!1,this.failCount=0,this.startWebSocket()}},{key:"startWebSocket",value:function(){var _this=this;return this.connected?!1:(__DEV?this.server=new WebSocket("ws://localhost:7777/"):this.server=new WebSocket("ws://ws."+__DOMAIN+"/"),this.server.onopen=function(){_this.failCount=0,_this.connected=!0},this.server.onclose=function(){_this.connected=!1,_this.failCount++;var waitTime=1e3*Math.random()*_this.failCount;setTimeout(function(){return _this.startWebSocket()},waitTime)},void(this.server.onmessage=function(e){Route.handle(JSON.parse(e.data))}))}},{key:"sendObj",value:function(object){return 0==this.connected?(alert("WebSocket is not connected."),!1):void this.server.send(JSON.stringify(object))}}]),WS}();WS.init();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Facebook=function(){function Facebook(){_classCallCheck(this,Facebook)}return _createClass(Facebook,null,[{key:"init",value:function(){var _this=this;this.connected=!1,window.fbAsyncInit=function(){FB.init({appId:__DEV?"243257116022228":"241489772865629",cookie:!0,xfbml:!0,version:"v2.5"}),_this.connected=!0,$(".fb-login").click(function(){FB.login(function(response){_this.statusChange(response)},{scope:"public_profile,email,user_friends"})}),$(".fb-logout").click(function(){FB.logout(function(response){_this.statusChange(response)})})},function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];d.getElementById(id)||(js=d.createElement(s),js.id=id,js.src="//connect.facebook.net/en_US/sdk.js",fjs.parentNode.insertBefore(js,fjs))}(document,"script","facebook-jssdk")}},{key:"requestTokenStatus",value:function(){var _this2=this;FB.getLoginStatus(function(response){_this2.statusChange(response)})}},{key:"statusChange",value:function(response){"connected"===response.status?WS.sendObj({x:"login",z:"token",screen:Lib.screenArea(),token:response.authResponse.accessToken}):WS.sendObj({x:"login",z:"token",screen:Lib.screenArea(),token:"Disconnected"})}}]),Facebook}();Facebook.init();var angularScope={connected:!1},app=angular.module("angularapp",[]);app.controller("AngularController",function($scope){$scope.AF={toggleArrayItem:function(array,item){return Lib.toggleArrayItem(array,item)},makePostDefault:function(){return{x:"post",z:"set",friends:[],link:"",thought:"",type:"text",date:Date.now()}}},$scope.people={},$scope.posts={},$scope.user={},$scope.page="loading",$scope.make_post=$scope.AF.makePostDefault(),$scope.comments=[],$scope.messages=[],$scope.capture_comment={},angularScope=$scope,$scope.connected=!0,$("body").removeClass("hide")});var postColumns={active:!1,inMemory:[],toggle:function(){this.active?this.off():this.on()},on:function(){this.active=!0,$("#page-home .narrow-wrapper").removeClass("narrow-wrapper").addClass("post-container"),this.update(),this.render()},off:function(){$("#page-home .post-container").addClass("narrow-wrapper").removeClass("post-container"),this.inMemory.forEach(function($value){$value.removeClass("processed"),$("#page-home .narrow-wrapper").append($value)}),$("#page-home .post-column").remove(),this.reset(),this.active=!1},update:function(){return this.active?(this.inMemory.push($("#page-home .post:not(.processed)").addClass("processed")),void this.render()):!1},reset:function(){return this.active?void(this.inMemory=[]):!1},resize:function(){if(!this.active)return!1;var col_num=Math.floor($("#page-home .post-container").width()/590);0==col_num&&(col_num=1);var real_num=$("#page-home .post-column").length;col_num!=real_num&&this.render()},render:function(){if(!this.active)return!1;var $temp=$("<div></div>").prependTo("#page-home .post-container");this.inMemory.forEach(function($value){$temp.append($value),$value.each(function(index,value){var $pic=$(value).find(".auto-link-picture"),height=$pic.attr("data-height");$pic.css({height:height+"px"})})});var col_num=Math.floor($("#page-home .post-container").width()/590);0==col_num&&(col_num=1);var real_num=$("#page-home .post-column").length;if(col_num!=real_num){$("#page-home .post-column").remove();for(var i=0;col_num>i;i++)$("#page-home .post-container").prepend($('<div class="post-column"></div>'))}this.inMemory.forEach(function($value){$value.each(function(index,value){var $smallest=!1;$("#page-home .post-column").each(function(index,value){$smallest===!1?$smallest=$(value):$(value).height()<$smallest.height()&&($smallest=$(value))}),$smallest.append($(value))})}),$temp.remove(),this.inMemory.forEach(function($value){$value.each(function(index,value){var $pic=$(value).find(".auto-link-picture");$pic.css({height:"auto"})})})}};$(".ws-echo").click(function(){WS.sendObj({x:"echo",text:"This is a message sent by the echo button."})});var nav_backdrop=Lib.backdrop($("#sidenav"),function(){nav_backdrop.close(),$("#sidenav").removeClass("open")});$("#sidenav .item:not(.nav-bars)").click(function(){nav_backdrop.click()}),$(".nav-bars").click(function(){$("#sidenav").hasClass("open")?nav_backdrop.click():($("#sidenav").addClass("open"),nav_backdrop.open())}),$(".nav-home").click(function(){WS.sendObj({x:"page",z:"home"})}),$("#page-home .load-more").click(function(){WS.sendObj({x:"page",z:"home",loaded:angularScope.posts.length})}),$(".nav-comments").click(function(){WS.sendObj({x:"page",z:"messages"})}),$(".nav-gear").click(function(){WS.sendObj({x:"page",z:"settings"})}),$(".nav-plus").click(function(){WS.sendObj({x:"page",z:"post"})}),$(".nav-people").click(function(){WS.sendObj({x:"page",z:"people"})}),$(".nav-about").click(function(){WS.sendObj({x:"page",z:"about"})}),$(".nav-update").click(function(){WS.sendObj({x:"login",z:"update"})}),$(window).on("dragover",function(e){e.preventDefault(),e.stopPropagation()}),$(window).on("dragenter",function(e){e.preventDefault(),e.stopPropagation(),$("#drop-overlay").removeClass("hide")}),$("#drop-overlay").on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),$("#drop-overlay").addClass("hide")}),$(window).on("drop",function(e){e.preventDefault(),e.stopPropagation(),$("#drop-overlay").addClass("hide");var data=Lib.getDropText(e);angularScope.make_post=angularScope.AF.makePostDefault(),""!=data.url?angularScope.make_post.link=data.url:""!=data.text&&(angularScope.make_post.thought=data.text),angularScope.make_post.link_html=data.url==data.html?"":data.html.substr(0,200),angularScope.$apply(),WS.sendObj({x:"page",z:"post"})}),$(window).on("resize",function(){postColumns.resize()});